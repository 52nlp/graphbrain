var rotateAndTranslate=function(c,h,d,b){var a=c[0];var j=c[1];var f=Math.cos(h)*a-Math.sin(h)*j;var e=Math.sin(h)*a+Math.cos(h)*j;a=f+d;j=e+b;c[0]=a;c[1]=j};var dotProduct=function(b,a){return(b[0]*a[0])+(b[1]*a[1])};var pointInTriangle=function(c,b,a,h){var p=[0,0];var n=[0,0];var l=[0,0];p[0]=a[0]-c[0];p[1]=a[1]-c[1];n[0]=b[0]-c[0];n[1]=b[1]-c[1];l[0]=h[0]-c[0];l[1]=h[1]-c[1];var m=dotProduct(p,p);var k=dotProduct(p,n);var j=dotProduct(p,l);var f=dotProduct(n,n);var d=dotProduct(n,l);var e=1/(m*f-k*k);var q=(f*j-k*d)*e;var o=(m*d-k*j)*e;return(q>0)&&(o>0)&&(q+o<1)};var Node=function(c,b,a){this.id=c;this.text=b;this.type=a;this.x=0;this.y=0;this.subNodes=[]};Node.prototype.moveTo=function(a,b){this.x=a;this.y=b;$("div#"+this.id).css("left",(this.x-(this.width/2))+"px");$("div#"+this.id).css("top",(this.y-(this.height/2))+"px");g.drawLinks()};Node.prototype.place=function(){var d=document.createElement("div");d.setAttribute("class","node");d.setAttribute("id",this.id);if(this.type=="text"){d.innerHTML='<a href="/node/'+this.id+'" id="'+this.id+'">'+this.text+"</a>"}else{if(this.type=="image"){d.innerHTML='<a href="/node/'+this.id+'" id="'+this.id+'"><img src="'+this.text+'" width="50px" /></a>'}}var b=document.getElementById("nodesDiv");b.appendChild(d);var c=$("div#"+this.id).width();var a=$("div#"+this.id).height();if(this.type=="image"){a=55}d.setAttribute("style","left:"+(this.x-(c/2))+"px; top:"+(this.y-(a/2))+"px;");this.width=c;this.height=a;var e=this;$("div#"+this.id).bind("mousedown",function(f){if(uiMode==="drag"){draggedNode=e;return false}else{newLink=new Link(0,e,false,"...");newLink.tx=f.pageX;newLink.ty=f.pageY;return false}});$("div#"+this.id).bind("click",function(f){if(dragging){dragging=false;return false}else{return true}});$("div#"+this.id).hover(function(f){if(newLink){newLink.targ=e}},function(f){})};var Link=function(d,c,a,b){this.id=d;this.orig=c;this.targ=a;this.type=b;this.ox=0;this.oy=0;this.tx=0;this.ty=0};Link.prototype.draw=function(d){var f=this.ox;var q=this.oy;if(this.orig){f=this.orig.x;q=this.orig.y}var e=this.tx;var o=this.ty;if(this.targ){e=this.targ.x;o=this.targ.y}var l=f+((e-f)/2);var j=q+((o-q)/2);var n=(o-q)/(e-f);var h=Math.atan(n);var k="#FFD326";var a="#000";if(~this.type.indexOf("direct")){k="#BEE512"}else{if(~this.type.indexOf("char")){k="#DFFD59"}else{if(~this.type.indexOf("play")){k="#FFFC26"}else{if(~this.type.indexOf("is")){k="#ED9107";a="#FFF"}}}}d.strokeStyle=k;d.fillStyle=k;d.lineWidth=0.7;d.beginPath();d.moveTo(f,q);d.lineTo(e,o);d.stroke();d.font="10pt Sans-Serif";var m=d.measureText(this.type);var c=m.width+6;var r=18;var b=[[0,0],[0,0],[0,0],[0,0],[0,0]];this.points=b;d.beginPath();if((f<e)||((f==e)&&(q<o))){b[0][0]=-(c/2);b[0][1]=-(r/2);b[1][0]=-(c/2);b[1][1]=(r/2);b[2][0]=(c/2);b[2][1]=(r/2);b[3][0]=(c/2)+6;b[3][1]=0;b[4][0]=(c/2);b[4][1]=-(r/2)}else{b[0][0]=-(c/2);b[0][1]=-(r/2);b[1][0]=-(c/2)-6;b[1][1]=0;b[2][0]=-(c/2);b[2][1]=(r/2);b[3][0]=(c/2);b[3][1]=(r/2);b[4][0]=(c/2);b[4][1]=-(r/2)}for(i=0;i<5;i++){rotateAndTranslate(b[i],h,l,j)}d.moveTo(b[0][0],b[0][1]);for(i=1;i<5;i++){d.lineTo(b[i][0],b[i][1])}d.closePath();d.fill();d.save();d.translate(l,j);d.rotate(h);d.fillStyle=a;d.textAlign="center";d.textBaseline="middle";d.fillText(this.type,0,0);d.restore()};Link.prototype.pointInLabel=function(a){return(pointInTriangle(this.points[0],this.points[1],this.points[2],a)||pointInTriangle(this.points[2],this.points[3],this.points[4],a)||pointInTriangle(this.points[0],this.points[2],this.points[4],a))};var Graph=function(a){this.context=a;this.nodes={};this.links=[];this.newNode=false;this.newNodeActive=false};Graph.prototype.drawLinks=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height);var a;for(a=0;a<this.links.length;a++){this.links[a].draw(this.context)}if(newLink){newLink.draw(this.context)}};Graph.prototype.placeNodes=function(){for(var a in g.nodes){if(g.nodes.hasOwnProperty(a)){g.nodes[a].place()}}};Graph.prototype.layout=function(a,f,d,b,p,o,m,j){a.x=p+((Math.random()*50)-25);a.y=o+((Math.random()*50)-25);var h=a.subNodes.length;var c=m;var l=f*150;var q=0;if(h==1){c+=(j-m)/2;q=Math.PI}else{if(f==1){q=(j-m)/h}else{q=(j-m)/(h-1);q*=0.75}}var e;for(e=0;e<h;e++){var n=d+(Math.sin(c)*l);var k=b+(Math.cos(c)*l);this.layout(a.subNodes[e],f+1,d,b,n,k,c-(q/2),c+(q/2));c+=q}};Graph.prototype.labelAtPoint=function(a,c){var b=[a,c];for(i=this.links.length-1;i>=0;i--){if(this.links[i].pointInLabel(b)){return this.links[i]}}return -1};var dragMode=function(a){uiMode="drag";$("#dragModeButton").addClass("selModeButton");$("#addModeButton").removeClass("selModeButton")};var addMode=function(a){uiMode="add";$("#dragModeButton").removeClass("selModeButton");$("#addModeButton").addClass("selModeButton");$("#tip").html("Try clicking & dragging!");$("#tip").fadeIn("slow",function(){tipVisible=true})};var g;var uiMode;var draggedNode;var dragging;var newLink;var tipVisible;$(function(){if(error!=""){$("#tip").html('<div class="error">'+error+"</div>");$("#tip").fadeIn("slow",function(){tipVisible=true})}newLink=false;draggedNode=false;dragging=false;curTargNode=false;tipVisible=false;$("#nodesDiv").bind("mousemove",(function(l){if(uiMode==="drag"){if(draggedNode){draggedNode.moveTo(l.pageX,l.pageY);dragging=true}}else{if(newLink){newLink.tx=l.pageX;newLink.ty=l.pageY;g.drawLinks();return false}}}));$("#nodesDiv").bind("mouseup",(function(l){if(uiMode==="drag"){draggedNode=false}else{if((newLink.orig)||(newLink.targ)){if(tipVisible){$(".tip").fadeOut("slow",function(){tipVisible=false})}$("#overlay").fadeIn(80,(function(n){$("#box").css({visibility:"visible"});if(newLink.orig){$("#dNode1").html(newLink.orig.text);$("#dNode1_id").val(newLink.orig.id);$("#dNode1").css({display:"block"});$("#dNode1In").css({display:"none"})}else{$("#dNode1").css({display:"none"});$("#dNode1In").css({display:"block"});$("#dNode1_id").val("none")}if(newLink.targ){$("#dNode2").html(newLink.targ.text);$("#dNode2_id").val(newLink.targ.id);$("#dNode2").css({display:"block"});$("#dNode2In").css({display:"none"})}else{$("#dNode2").css({display:"none"});$("#dNode2In").css({display:"block"});$("#dNode2_id").val("none")}newLink.targ=false}))}else{newLink=false;g.drawLinks()}}}));$("#boxclose").click(function(){$("#overlay").fadeOut(80,(function(l){$("#box").css({visibility:"hidden"});newLink=false;g.drawLinks()}))});dragMode();$("#dragModeButton").bind("click",dragMode);$("#addModeButton").bind("click",addMode);$("#nodesDiv").bind("mousedown",function(l){if(uiMode==="drag"){return false}else{newLink=new Link(0,false,false,"...");newLink.ox=l.pageX;newLink.oy=l.pageY;newLink.tx=l.pageX;newLink.ty=l.pageY;return false}});$("#nodesDiv").bind("click",(function(l){f=g.labelAtPoint(l.pageX,l.pageY);if(f!=-1){if(confirm('Do you want to delete connection:\n"'+f.orig.text+" "+f.type+" "+f.targ.text+'"?')){document.forms.delinkForm.elements.link_orig.value=f.orig.id;document.forms.delinkForm.elements.link_targ.value=f.targ.id;document.forms.delinkForm.elements.link_type.value=f.type;$("#delinkForm").submit()}}}));var e=document.getElementById("graphCanvas");var b=e.getContext("2d");g=new Graph(b);b.translate(0.5,0.5);var j;for(j=0;j<nodes.length;j++){var c=nodes[j];var a=c.id;var q=c.text;var m=c.type;var p=c.parent;var d=new Node(a,q,m);g.nodes[a]=d}for(j=0;j<nodes.length;j++){var c=nodes[j];var a=c.id;var p=c.parent;if(p==""){g.root=g.nodes[a];g.nodes[a].parent=false}else{g.nodes[a].parent=g.nodes[p];g.nodes[p].subNodes[g.nodes[p].subNodes.length]=g.nodes[a]}}for(j=0;j<links.length;j++){var f=links[j];var o=new Link(f.id,g.nodes[f.orig],g.nodes[f.targ],f.type);g.links.push(o)}var h=window.innerWidth/2;var k=window.innerHeight/2;g.layout(g.root,1,h,k,h,k,0,Math.PI*2);b.canvas.width=window.innerWidth;b.canvas.height=window.innerHeight;g.drawLinks();g.placeNodes()});