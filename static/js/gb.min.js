var rotateAndTranslate=function(c,h,d,b){var a=c[0];var j=c[1];var f=Math.cos(h)*a-Math.sin(h)*j;var e=Math.sin(h)*a+Math.cos(h)*j;a=f+d;j=e+b;c[0]=a;c[1]=j};var dotProduct=function(b,a){return(b[0]*a[0])+(b[1]*a[1])};var pointInTriangle=function(c,b,a,h){var q=[0,0];var o=[0,0];var m=[0,0];q[0]=a[0]-c[0];q[1]=a[1]-c[1];o[0]=b[0]-c[0];o[1]=b[1]-c[1];m[0]=h[0]-c[0];m[1]=h[1]-c[1];var n=dotProduct(q,q);var k=dotProduct(q,o);var j=dotProduct(q,m);var f=dotProduct(o,o);var d=dotProduct(o,m);var e=1/(n*f-k*k);var r=(f*j-k*d)*e;var p=(n*d-k*j)*e;return(r>0)&&(p>0)&&(r+p<1)};var interRect=function(b,m,a,k,f,s,n,o){var q,j,h,c;var r=a-b;var p=k-m;if((r==0)&&(p==0)){return 0}if(r!=0){var c;if(r>0){c=n}else{c=f}j=(c-b)/r}if(p!=0){var c;if(p>0){c=o}else{c=s}h=(c-m)/p}if(r==0){q=h}else{if(p==0){q=j}else{if(j<h){q=j}else{q=h}}}var e=b+r*q;var d=m+p*q;return[e,d]};var Node=function(d,c,b,a){this.id=d;this.text=c;this.type=b;this.x=0;this.y=0;this.vX=0;this.vY=0;this.subNodes=[];this.snode=a};Node.prototype.updatePos=function(){var b=$("#"+this.id);var a=b.offset();this.x=a.left+(this.width/2);this.y=a.top+(this.height/2)};Node.prototype.place=function(){var d=document.createElement("div");d.setAttribute("class","node");d.setAttribute("id",this.id);if(this.type=="text"){d.innerHTML='<a href="/node/'+this.id+'" id="'+this.id+'">'+this.text+"</a>"}else{if(this.type=="image"){d.innerHTML='<a href="/node/'+this.id+'" id="'+this.id+'"><img src="'+this.text+'" width="50px" /></a>'}}var b=document.getElementById(this.snode.id);b.appendChild(d);var e=$("#"+this.id);var c=e.width();var a=e.height();if(this.type=="image"){a=55}this.width=c;this.height=a;this.updatePos()};var SNode=function(a){this.id=a;this.x=0;this.y=0;this.vX=0;this.vY=0;this.nodes=[];this.subNodes=[];this.parent="unknown"};SNode.prototype.moveTo=function(a,d,c){c=typeof(c)!=="undefined"?c:true;this.x=a;this.y=d;$("div#"+this.id).css("left",(this.x-(this.width/2))+"px");$("div#"+this.id).css("top",(this.y-(this.height/2))+"px");for(var b in this.nodes){this.nodes[b].updatePos()}if(c){g.drawLinks()}};SNode.prototype.place=function(){var c=document.createElement("div");c.setAttribute("class","snode");c.setAttribute("id",this.id);var b=document.getElementById("nodesDiv");b.appendChild(c);for(var d in this.nodes){this.nodes[d].place()}var e=$("div#"+this.id).width();var a=$("div#"+this.id).height();c.setAttribute("style","left:"+(this.x-(e/2))+"px; top:"+(this.y-(a/2))+"px;");this.width=e;this.height=a;var f=this;$("div#"+this.id).bind("mousedown",function(h){if(uiMode==="drag"){draggedNode=f;return false}else{newLink=new Link(0,f,false,"...");newLink.tx=h.pageX;newLink.ty=h.pageY;return false}});$("div#"+this.id).bind("click",function(h){if(dragging){dragging=false;return false}else{return true}});$("div#"+this.id).hover(function(h){if(newLink){newLink.targ=f}},function(h){})};var Link=function(f,e,d,b,a,c){this.id=f;this.orig=e;this.sorig=d;this.targ=b;this.starg=a;this.type=c;this.ox=0;this.oy=0;this.tx=0;this.ty=0};Link.prototype.draw=function(d){var f=this.ox;var r=this.oy;if(this.orig){f=this.orig.x;r=this.orig.y}else{if(this.sorig){f=this.sorig.x;r=this.sorig.y}}var e=this.tx;var q=this.ty;if(this.targ){e=this.targ.x;q=this.targ.y}else{if(this.starg){e=this.starg.x;q=this.starg.y}}var m=f+((e-f)/2);var j=r+((q-r)/2);var o=(q-r)/(e-f);var h=Math.atan(o);var k="#FFD326";var a="#000";if(~this.type.indexOf("direct")){k="#BEE512"}else{if(~this.type.indexOf("char")){k="#DFFD59"}else{if(~this.type.indexOf("play")){k="#FFFC26"}else{if(~this.type.indexOf("is")){k="#ED9107";a="#FFF"}}}}d.strokeStyle=k;d.fillStyle=k;d.lineWidth=0.7;d.beginPath();d.moveTo(f,r);d.lineTo(e,q);d.stroke();d.font="10pt Sans-Serif";var n=d.measureText(this.type);var c=n.width+6;var s=18;var b=[[0,0],[0,0],[0,0],[0,0],[0,0]];this.points=b;d.beginPath();if((f<e)||((f==e)&&(r<q))){b[0][0]=-(c/2);b[0][1]=-(s/2);b[1][0]=-(c/2);b[1][1]=(s/2);b[2][0]=(c/2);b[2][1]=(s/2);b[3][0]=(c/2)+6;b[3][1]=0;b[4][0]=(c/2);b[4][1]=-(s/2)}else{b[0][0]=-(c/2);b[0][1]=-(s/2);b[1][0]=-(c/2)-6;b[1][1]=0;b[2][0]=-(c/2);b[2][1]=(s/2);b[3][0]=(c/2);b[3][1]=(s/2);b[4][0]=(c/2);b[4][1]=-(s/2)}for(i=0;i<5;i++){rotateAndTranslate(b[i],h,m,j)}d.moveTo(b[0][0],b[0][1]);for(i=1;i<5;i++){d.lineTo(b[i][0],b[i][1])}d.closePath();d.fill();d.save();d.translate(m,j);d.rotate(h);d.fillStyle=a;d.textAlign="center";d.textBaseline="middle";d.fillText(this.type,0,0);d.restore()};Link.prototype.pointInLabel=function(a){return(pointInTriangle(this.points[0],this.points[1],this.points[2],a)||pointInTriangle(this.points[2],this.points[3],this.points[4],a)||pointInTriangle(this.points[0],this.points[2],this.points[4],a))};var Graph=function(a){this.context=a;this.snodes={};this.nodes={};this.links=[];this.newNode=false;this.newNodeActive=false};Graph.prototype.drawLinks=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height);var a;for(a=0;a<this.links.length;a++){this.links[a].draw(this.context)}if(newLink){newLink.draw(this.context)}};Graph.prototype.placeNodes=function(){for(var a in this.snodes){this.snodes[a].place()}};Graph.prototype.layout=function(a,f,d,b,q,p,n,j){a.x=q+((Math.random()*50)-25);a.y=p+((Math.random()*50)-25);var h=a.subNodes.length;var c=n;var m=f*150;var r=0;if(h==1){c+=(j-n)/2;r=Math.PI}else{if(f==1){r=(j-n)/h}else{r=(j-n)/(h-1);r*=0.75}}var e;for(var e=0;e<h;e++){var o=d+(Math.sin(c)*m);var k=b+(Math.cos(c)*m);this.layout(a.subNodes[e],f+1,d,b,o,k,c-(r/2),c+(r/2));c+=r}};Graph.prototype.labelAtPoint=function(a,d){var c=[a,d];for(var b=this.links.length-1;b>=0;b--){if(this.links[b].pointInLabel(c)){return this.links[b]}}return -1};Graph.prototype.genSNodeKeys=function(){this.snodeKeys=[];for(var a in this.snodes){this.snodeKeys.push(a)}};Graph.prototype.forceStep=function(){var k=0.85;var m=200;var t=0.06;for(var s in this.snodes){var c=this.snodes[s];c.fX=0;c.fY=0}for(var h=0;h<this.snodeKeys.length;h++){var r=this.snodes[this.snodeKeys[h]];for(var f=h+1;f<this.snodeKeys.length;f++){var p=this.snodes[this.snodeKeys[f]];var e=r.x-p.x;var d=r.y-p.y;var a=(e*e)+(d*d);var o=(e/a)*m;var n=(d/a)*m;r.fX+=o;r.fY+=n;p.fX-=o;p.fY-=n}}for(var h=0;h<this.links.length;h++){var q=this.links[h];var r=q.sorig;var p=q.starg;var e=r.x-p.x;var d=r.y-p.y;var o=e*t;var n=d*t;r.fX-=o;r.fY-=n;p.fX+=o;p.fY+=n}for(var s in this.snodes){var b=this.snodes[s];if(b.parent!=""){b.vX=(b.vX+b.fX)*k;b.vY=(b.vY+b.fY)*k;b.x=b.x+b.vX;b.y=b.y+b.vY}}};var dragMode=function(a){uiMode="drag";$("#dragModeButton").addClass("selModeButton");$("#addModeButton").removeClass("selModeButton")};var addMode=function(a){uiMode="add";$("#dragModeButton").removeClass("selModeButton");$("#addModeButton").addClass("selModeButton");$("#tip").html("Try clicking & dragging!");$("#tip").fadeIn("slow",function(){tipVisible=true})};var cycle=0;var graphAnim=function(){for(var c=0;c<20;c++){g.forceStep()}for(var b in g.snodes){var a=g.snodes[b];a.moveTo(a.x,a.y,false)}g.drawLinks();cycle+=1;if(cycle<5){setTimeout("graphAnim()",100)}};var g;var uiMode;var draggedNode;var dragging;var newLink;var tipVisible;var initInterface=function(){if(error!=""){$("#tip").html('<div class="error">'+error+"</div>");$("#tip").fadeIn("slow",function(){tipVisible=true})}newLink=false;draggedNode=false;dragging=false;curTargNode=false;tipVisible=false;$("#nodesDiv").bind("mousemove",(function(a){if(uiMode==="drag"){if(draggedNode){draggedNode.moveTo(a.pageX,a.pageY);dragging=true}}else{if(newLink){newLink.tx=a.pageX;newLink.ty=a.pageY;g.drawLinks();return false}}}));$("#nodesDiv").bind("mouseup",(function(a){if(uiMode==="drag"){draggedNode=false}else{if((newLink.orig)||(newLink.targ)){if(tipVisible){$(".tip").fadeOut("slow",function(){tipVisible=false})}$("#overlay").fadeIn(80,(function(b){$("#box").css({visibility:"visible"});if(newLink.orig){$("#dNode1").html(newLink.orig.text);$("#dNode1_id").val(newLink.orig.id);$("#dNode1").css({display:"block"});$("#dNode1In").css({display:"none"})}else{$("#dNode1").css({display:"none"});$("#dNode1In").css({display:"block"});$("#dNode1_id").val("none")}if(newLink.targ){$("#dNode2").html(newLink.targ.text);$("#dNode2_id").val(newLink.targ.id);$("#dNode2").css({display:"block"});$("#dNode2In").css({display:"none"})}else{$("#dNode2").css({display:"none"});$("#dNode2In").css({display:"block"});$("#dNode2_id").val("none")}newLink.targ=false}))}else{newLink=false;g.drawLinks()}}}));$("#boxclose").click(function(){$("#overlay").fadeOut(80,(function(a){$("#box").css({visibility:"hidden"});newLink=false;g.drawLinks()}))});dragMode();$("#dragModeButton").bind("click",dragMode);$("#addModeButton").bind("click",addMode);$("#nodesDiv").bind("mousedown",function(a){if(uiMode==="drag"){return false}else{newLink=new Link(0,false,false,"...");newLink.ox=a.pageX;newLink.oy=a.pageY;newLink.tx=a.pageX;newLink.ty=a.pageY;return false}});$("#nodesDiv").bind("click",(function(a){l=g.labelAtPoint(a.pageX,a.pageY);if(l!=-1){if(confirm('Do you want to delete connection:\n"'+l.orig.text+" "+l.type+" "+l.targ.text+'"?')){document.forms.delinkForm.elements.link_orig.value=l.orig.id;document.forms.delinkForm.elements.link_targ.value=l.targ.id;document.forms.delinkForm.elements.link_type.value=l.type;$("#delinkForm").submit()}}}))};var initGraph=function(){var z=document.getElementById("graphCanvas");var b=z.getContext("2d");g=new Graph(b);b.translate(0.5,0.5);var x,w;for(x=0;x<snodes.length;x++){var y=snodes[x];var e=y.id;var v=y.nodes;var s=new SNode(e);for(w=0;w<v.length;w++){var m=v[w];var o=nodes[m];var p=o.text;var d=o.type;var k=o.parent;var t=new Node(m,p,d,s);s.nodes[m]=t;g.nodes[m]=t;if((s.parent=="unknown")||(k=="")){s.parent=k}}g.snodes[e]=s}for(x=0;x<snodes.length;x++){var e=snodes[x]["id"];var s=g.snodes[e];var k=s.parent;if(k==""){g.root=s;s.parent=false}else{s.parent=g.nodes[k].snode;g.nodes[k].snode.subNodes[g.nodes[k].snode.subNodes.length]=s}}g.genSNodeKeys();for(x=0;x<links.length;x++){var u=links[x];var c="";var q="";var a="";var n="";if("orig" in u){c=g.nodes[u.orig];a=c.snode}else{c=false;a=g.snodes[u.sorig]}if("targ" in u){q=g.nodes[u.targ];n=q.snode}else{q=false;n=g.snodes[u.starg]}var f=new Link(u.id,c,a,q,n,u.relation);g.links.push(f)}var h=window.innerWidth/2;var r=window.innerHeight/2;g.layout(g.root,1,h,r,h,r,0,Math.PI*2);b.canvas.width=window.innerWidth;b.canvas.height=window.innerHeight;g.drawLinks();g.placeNodes();graphAnim()};$(function(){console.log(interRect(5,5,20,7.6,0,0,11,11));initInterface();initGraph()});