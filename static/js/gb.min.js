var rotateAndTranslate=function(c,h,d,b){var a=c[0];var j=c[1];var f=Math.cos(h)*a-Math.sin(h)*j;var e=Math.sin(h)*a+Math.cos(h)*j;a=f+d;j=e+b;c[0]=a;c[1]=j};var dotProduct=function(b,a){return(b[0]*a[0])+(b[1]*a[1])};var pointInTriangle=function(c,b,a,h){var q=[0,0];var o=[0,0];var m=[0,0];q[0]=a[0]-c[0];q[1]=a[1]-c[1];o[0]=b[0]-c[0];o[1]=b[1]-c[1];m[0]=h[0]-c[0];m[1]=h[1]-c[1];var n=dotProduct(q,q);var k=dotProduct(q,o);var j=dotProduct(q,m);var f=dotProduct(o,o);var d=dotProduct(o,m);var e=1/(n*f-k*k);var r=(f*j-k*d)*e;var p=(n*d-k*j)*e;return(r>0)&&(p>0)&&(r+p<1)};var interRect=function(b,m,a,k,f,s,n,o){var q,j,h,c;var r=a-b;var p=k-m;if((r==0)&&(p==0)){return 0}if(r!=0){var c;if(r>0){c=n}else{c=f}j=(c-b)/r}if(p!=0){var c;if(p>0){c=o}else{c=s}h=(c-m)/p}if(r==0){q=h}else{if(p==0){q=j}else{if(j<h){q=j}else{q=h}}}var e=b+r*q;var d=m+p*q;return[e,d]};var rectsOverlap=function(f,j,e,h,b,d,a,c){if(f<a&&e>b&&j<c&&h>d){return true}return false};var sepAxisSide=function(c,b,a){var e=-c.y;var d=c.x;var f=e*(a.x-b.x)+d*(a.y-b.y);if(f<0){return -1}else{return 1}};var sepAxis=function(e,c,b,f){var d=sepAxisSide(e,c,b);var a=sepAxisSide(e,c,f.v1);if(d==a){return false}if(a!=sepAxisSide(e,c,f.v2)){return false}if(a!=sepAxisSide(e,c,f.v3)){return false}if(a!=sepAxisSide(e,c,f.v4)){return false}return true};var rotRectsOverlap=function(b,a){if(sepAxis(b.v1,b.v2,b.v3,a)){return false}if(sepAxis(b.v2,b.v3,b.v1,a)){return false}if(sepAxis(b.v3,b.v4,b.v1,a)){return false}if(sepAxis(b.v4,b.v1,b.v2,a)){return false}if(sepAxis(a.v1,a.v2,a.v3,b)){return false}if(sepAxis(a.v2,a.v3,a.v1,b)){return false}if(sepAxis(a.v3,a.v4,a.v1,b)){return false}if(sepAxis(a.v4,a.v1,a.v2,b)){return false}return true};var rectsDist2=function(b,o,a,m,r,f,q,e){if(rectsOverlap(b,o,a,m,r,f,q,e)){return 0}var j=b+((a-b)/2);var h=o+((m-o)/2);var p=r+((q-r)/2);var n=f+((e-f)/2);var t=interRect(j,h,p,n,b,o,a,m);var s=interRect(p,n,j,h,r,f,q,e);var d=t[0]-s[0];var c=t[1]-s[1];var k=(d*d)+(c*c);return k};var rectsDist=function(b,h,a,f,k,d,j,c){var e=rectsDist2(b,h,a,f,k,d,j,c);e=Math.sqrt(e);return e};var Node=function(d,c,b,a){this.id=d;this.text=c;this.type=b;this.x=0;this.y=0;this.vX=0;this.vY=0;this.subNodes=[];this.snode=a};Node.prototype.updatePos=function(){var b=$("#"+this.id);var a=b.offset();this.x=a.left+this.halfWidth;this.y=a.top+this.halfHeight;this.x0=this.x-this.halfWidth;this.y0=this.y-this.halfHeight;this.x1=this.x+this.halfWidth;this.y1=this.y+this.halfHeight};Node.prototype.place=function(){var d=document.createElement("div");d.setAttribute("class","node");d.setAttribute("id",this.id);if(this.type=="text"){d.innerHTML='<a href="/node/'+this.id+'" id="'+this.id+'">'+this.text+"</a>"}else{if(this.type=="image"){d.innerHTML='<a href="/node/'+this.id+'" id="'+this.id+'"><img src="'+this.text+'" width="50px" /></a>'}}var b=document.getElementById(this.snode.id);b.appendChild(d);var e=$("#"+this.id);var c=e.outerWidth();var a=e.outerHeight();if(this.type=="image"){a=55}this.width=c;this.height=a;this.halfWidth=c/2;this.halfHeight=a/2;this.updatePos()};var SNode=function(a){this.id=a;this.x=0;this.y=0;this.vX=0;this.vY=0;this.nodes=[];this.subNodes=[];this.parent="unknown"};SNode.prototype.moveTo=function(a,d,c){c=typeof(c)!=="undefined"?c:true;this.x=a;this.y=d;this.x0=this.x-this.halfWidth;this.y0=this.y-this.halfHeight;this.x1=this.x+this.halfWidth;this.y1=this.y+this.halfHeight;$("div#"+this.id).css("left",(this.x-this.halfWidth)+"px");$("div#"+this.id).css("top",(this.y-this.halfHeight)+"px");this.rect=[];this.rect.v1=[];this.rect.v2=[];this.rect.v3=[];this.rect.v4=[];this.rect.v1.x=this.x-this.halfWidth;this.rect.v1.y=this.y-this.halfHeight;this.rect.v2.x=this.x-this.halfWidth;this.rect.v2.y=this.y+this.halfHeight;this.rect.v3.x=this.x+this.halfWidth;this.rect.v3.y=this.y+this.halfHeight;this.rect.v4.x=this.x+this.halfWidth;this.rect.v4.y=this.y-this.halfHeight;for(var b in this.nodes){this.nodes[b].updatePos()}if(c){g.drawLinks()}};SNode.prototype.place=function(){var c=document.createElement("div");var f=0;for(var d in this.nodes){if(this.nodes.hasOwnProperty(d)){f++}}if(f>1){c.setAttribute("class","snode")}else{c.setAttribute("class","snode1")}c.setAttribute("id",this.id);var b=document.getElementById("nodesDiv");b.appendChild(c);for(var d in this.nodes){this.nodes[d].place()}var e=$("div#"+this.id).outerWidth();var a=$("div#"+this.id).outerHeight();this.width=e;this.height=a;this.halfWidth=e/2;this.halfHeight=a/2;this.moveTo(this.x,this.y);var h=this;$("div#"+this.id).bind("mousedown",function(j){if(uiMode==="drag"){draggedNode=h;return false}else{newLink=new Link(0,h,false,"...");newLink.tx=j.pageX;newLink.ty=j.pageY;return false}});$("div#"+this.id).bind("click",function(j){if(dragging){dragging=false;return false}else{return true}});$("div#"+this.id).hover(function(j){if(newLink){newLink.targ=h}},function(j){})};var Link=function(h,f,d,c,a,b){this.id=h;this.orig=f;this.sorig=d;this.targ=c;this.starg=a;this.label=b;this.ox=0;this.oy=0;this.tx=0;this.ty=0;context.font="10pt Sans-Serif";var e=context.measureText(this.label);this.width=e.width+6;this.height=18;this.halfWidth=this.width/2;this.halfHeight=this.height/2};Link.prototype.updatePos=function(){var k=false;var f=false;var d=false;var h=false;if(this.orig){k=this.orig}else{if(this.sorig){k=this.sorig;this.origSuper=true}}if(this.targ){f=this.targ}else{if(this.starg){f=this.starg;this.targSuper=true}}var c=k.x;var m=k.y;var b=f.x;var j=f.y;p0=interRect(c,m,b,j,k.x0,k.y0,k.x1,k.y1);p1=interRect(b,j,c,m,f.x0,f.y0,f.x1,f.y1);this.x0=p0[0];this.y0=p0[1];this.x1=p1[0];this.y1=p1[1];this.cx=this.x0+((this.x1-this.x0)/2);this.cy=this.y0+((this.y1-this.y0)/2);var e=(this.y1-this.y0)/(this.x1-this.x0);this.angle=Math.atan(e);var a=[[0,0],[0,0],[0,0],[0,0],[0,0]];if((this.x0<this.x1)||((this.x0==this.x1)&&(this.y0<this.y1))){a[0][0]=-this.halfWidth;a[0][1]=-this.halfHeight;a[1][0]=-this.halfWidth;a[1][1]=this.halfHeight;a[2][0]=this.halfWidth;a[2][1]=this.halfHeight;a[3][0]=this.halfWidth+6;a[3][1]=0;a[4][0]=this.halfWidth;a[4][1]=-this.halfHeight}else{a[0][0]=-this.halfWidth;a[0][1]=-this.halfHeight;a[1][0]=-this.halfWidth-6;a[1][1]=0;a[2][0]=-this.halfWidth;a[2][1]=this.halfHeight;a[3][0]=this.halfWidth;a[3][1]=this.halfHeight;a[4][0]=this.halfWidth;a[4][1]=-this.halfHeight}for(i=0;i<5;i++){rotateAndTranslate(a[i],this.angle,this.cx,this.cy)}this.points=a;this.rect=[];this.rect.v1=[];this.rect.v2=[];this.rect.v3=[];this.rect.v4=[];this.rect.v1.x=a[0][0];this.rect.v1.y=a[0][1];this.rect.v2.x=a[1][0];this.rect.v2.y=a[1][1];this.rect.v3.x=a[2][0];this.rect.v3.y=a[2][1];this.rect.v4.x=a[4][0];this.rect.v4.y=a[4][1]};Link.prototype.draw=function(){this.updatePos();var c="#FFD326";var b="#000";if(~this.label.indexOf("direct")){c="#BEE512"}else{if(~this.label.indexOf("char")){c="#DFFD59"}else{if(~this.label.indexOf("play")){c="#FFFC26"}else{if(~this.label.indexOf("is")){c="#ED9107";b="#FFF"}}}}context.strokeStyle=c;context.fillStyle=c;context.lineWidth=0.7;context.beginPath();context.moveTo(this.x0,this.y0);context.lineTo(this.x1,this.y1);context.stroke();if(this.origSuper){context.fillStyle="#505050"}else{context.fillStyle=c}context.beginPath();var a=4;context.arc(this.x0,this.y0,a,0,2*Math.PI,false);context.fill();if(this.targSuper){context.fillStyle="#505050"}else{context.fillStyle=c}context.beginPath();context.arc(this.x1,this.y1,a,0,2*Math.PI,false);context.fill();context.fillStyle=c;context.beginPath();context.moveTo(this.points[0][0],this.points[0][1]);for(i=1;i<5;i++){context.lineTo(this.points[i][0],this.points[i][1])}context.closePath();context.fill();context.save();context.translate(this.cx,this.cy);context.rotate(this.angle);context.font="10pt Sans-Serif";context.fillStyle=b;context.textAlign="center";context.textBaseline="middle";context.fillText(this.label,0,0);context.restore()};Link.prototype.pointInLabel=function(a){return(pointInTriangle(this.points[0],this.points[1],this.points[2],a)||pointInTriangle(this.points[2],this.points[3],this.points[4],a)||pointInTriangle(this.points[0],this.points[2],this.points[4],a))};var Graph=function(){this.snodes={};this.nodes={};this.links=[];this.newNode=false;this.newNodeActive=false};Graph.prototype.drawLinks=function(){context.clearRect(0,0,context.canvas.width,context.canvas.height);var a;for(a=0;a<this.links.length;a++){this.links[a].draw()}if(newLink){newLink.draw()}};Graph.prototype.placeNodes=function(){for(var a in this.snodes){this.snodes[a].place()}};Graph.prototype.layout=function(a,f,d,b,q,p,n,j){a.x=q+((Math.random()*50)-25);a.y=p+((Math.random()*50)-25);var h=a.subNodes.length;var c=n;var m=f*150;var r=0;if(h==1){c+=(j-n)/2;r=Math.PI}else{if(f==1){r=(j-n)/h}else{r=(j-n)/(h-1);r*=0.75}}var e;for(var e=0;e<h;e++){var o=d+(Math.sin(c)*m);var k=b+(Math.cos(c)*m);this.layout(a.subNodes[e],f+1,d,b,o,k,c-(r/2),c+(r/2));c+=r}};Graph.prototype.labelAtPoint=function(a,d){var c=[a,d];for(var b=this.links.length-1;b>=0;b--){if(this.links[b].pointInLabel(c)){return this.links[b]}}return -1};Graph.prototype.genSNodeKeys=function(){this.snodeKeys=[];for(var a in this.snodes){this.snodeKeys.push(a)}};Graph.prototype.forceStep=function(){var k=0.85;var m=300;var t=0.06;for(var s in this.snodes){var c=this.snodes[s];c.fX=0;c.fY=0}for(var h=0;h<this.snodeKeys.length;h++){var r=this.snodes[this.snodeKeys[h]];for(var f=h+1;f<this.snodeKeys.length;f++){var p=this.snodes[this.snodeKeys[f]];var e=r.x-p.x;var d=r.y-p.y;var a=(e*e)+(d*d);var o=(e/a)*m;var n=(d/a)*m;r.fX+=o;r.fY+=n;p.fX-=o;p.fY-=n}}for(var h=0;h<this.links.length;h++){var q=this.links[h];var r=q.sorig;var p=q.starg;var e=r.x-p.x;var d=r.y-p.y;var o=e*t;var n=d*t;r.fX-=o;r.fY-=n;p.fX+=o;p.fY+=n}for(var s in this.snodes){var b=this.snodes[s];if(b.parent!=""){b.vX=(b.vX+b.fX)*k;b.vY=(b.vY+b.fY)*k;b.x=b.x+b.vX;b.y=b.y+b.vY}}};var dragMode=function(a){uiMode="drag";$("#dragModeButton").addClass("selModeButton");$("#addModeButton").removeClass("selModeButton")};var addMode=function(a){uiMode="add";$("#dragModeButton").removeClass("selModeButton");$("#addModeButton").addClass("selModeButton");$("#tip").html("Try clicking & dragging!");$("#tip").fadeIn("slow",function(){tipVisible=true})};var cycle=0;var graphAnim=function(){for(var c=0;c<20;c++){g.forceStep()}for(var b in g.snodes){var a=g.snodes[b];a.moveTo(a.x,a.y,false)}g.drawLinks();cycle+=1;if(cycle<5){setTimeout("graphAnim()",100)}};var g;var context;var uiMode;var draggedNode;var dragging;var newLink;var tipVisible;var initInterface=function(){if(error!=""){$("#tip").html('<div class="error">'+error+"</div>");$("#tip").fadeIn("slow",function(){tipVisible=true})}newLink=false;draggedNode=false;dragging=false;curTargNode=false;tipVisible=false;$("#nodesDiv").bind("mousemove",(function(a){if(uiMode==="drag"){if(draggedNode){draggedNode.moveTo(a.pageX,a.pageY);dragging=true}}else{if(newLink){newLink.tx=a.pageX;newLink.ty=a.pageY;g.drawLinks();return false}}}));$("#nodesDiv").bind("mouseup",(function(a){if(uiMode==="drag"){draggedNode=false}else{if((newLink.orig)||(newLink.targ)){if(tipVisible){$(".tip").fadeOut("slow",function(){tipVisible=false})}$("#overlay").fadeIn(80,(function(b){$("#box").css({visibility:"visible"});if(newLink.orig){$("#dNode1").html(newLink.orig.text);$("#dNode1_id").val(newLink.orig.id);$("#dNode1").css({display:"block"});$("#dNode1In").css({display:"none"})}else{$("#dNode1").css({display:"none"});$("#dNode1In").css({display:"block"});$("#dNode1_id").val("none")}if(newLink.targ){$("#dNode2").html(newLink.targ.text);$("#dNode2_id").val(newLink.targ.id);$("#dNode2").css({display:"block"});$("#dNode2In").css({display:"none"})}else{$("#dNode2").css({display:"none"});$("#dNode2In").css({display:"block"});$("#dNode2_id").val("none")}newLink.targ=false}))}else{newLink=false;g.drawLinks()}}}));$("#boxclose").click(function(){$("#overlay").fadeOut(80,(function(a){$("#box").css({visibility:"hidden"});newLink=false;g.drawLinks()}))});dragMode();$("#dragModeButton").bind("click",dragMode);$("#addModeButton").bind("click",addMode);$("#nodesDiv").bind("mousedown",function(a){if(uiMode==="drag"){return false}else{newLink=new Link(0,false,false,"...");newLink.ox=a.pageX;newLink.oy=a.pageY;newLink.tx=a.pageX;newLink.ty=a.pageY;return false}});$("#nodesDiv").bind("click",(function(a){l=g.labelAtPoint(a.pageX,a.pageY);if(l!=-1){if(confirm('Do you want to delete connection:\n"'+l.orig.text+" "+l.type+" "+l.targ.text+'"?')){document.forms.delinkForm.elements.link_orig.value=l.orig.id;document.forms.delinkForm.elements.link_targ.value=l.targ.id;document.forms.delinkForm.elements.link_type.value=l.type;$("#delinkForm").submit()}}}))};var initGraph=function(){var y=document.getElementById("graphCanvas");context=y.getContext("2d");g=new Graph();context.translate(0.5,0.5);var w,v;for(w=0;w<snodes.length;w++){var x=snodes[w];var d=x.id;var u=x.nodes;var r=new SNode(d);for(v=0;v<u.length;v++){var k=u[v];var n=nodes[k];var o=n.text;var c=n.type;var h=n.parent;var s=new Node(k,o,c,r);r.nodes[k]=s;g.nodes[k]=s;if((r.parent=="unknown")||(h=="")){r.parent=h}}g.snodes[d]=r}for(w=0;w<snodes.length;w++){var d=snodes[w]["id"];var r=g.snodes[d];var h=r.parent;if(h==""){g.root=r;r.parent=false}else{r.parent=g.nodes[h].snode;g.nodes[h].snode.subNodes[g.nodes[h].snode.subNodes.length]=r}}g.genSNodeKeys();for(w=0;w<links.length;w++){var t=links[w];var b="";var p="";var a="";var m="";if("orig" in t){b=g.nodes[t.orig];a=b.snode}else{b=false;a=g.snodes[t.sorig]}if("targ" in t){p=g.nodes[t.targ];m=p.snode}else{p=false;m=g.snodes[t.starg]}var e=new Link(t.id,b,a,p,m,t.relation);g.links.push(e)}var f=window.innerWidth/2;var q=window.innerHeight/2;g.layout(g.root,1,f,q,f,q,0,Math.PI*2);context.canvas.width=window.innerWidth;context.canvas.height=window.innerHeight;g.drawLinks();g.placeNodes();graphAnim()};$(function(){initInterface();initGraph()});