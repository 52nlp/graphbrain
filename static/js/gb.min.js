var rotateAndTranslate=function(c,h,d,b){var a=c[0];var j=c[1];var f=Math.cos(h)*a-Math.sin(h)*j;var e=Math.sin(h)*a+Math.cos(h)*j;a=f+d;j=e+b;c[0]=a;c[1]=j};var dotProduct=function(b,a){return(b[0]*a[0])+(b[1]*a[1])};var pointInTriangle=function(c,b,a,h){var q=[0,0];var o=[0,0];var m=[0,0];q[0]=a[0]-c[0];q[1]=a[1]-c[1];o[0]=b[0]-c[0];o[1]=b[1]-c[1];m[0]=h[0]-c[0];m[1]=h[1]-c[1];var n=dotProduct(q,q);var k=dotProduct(q,o);var j=dotProduct(q,m);var f=dotProduct(o,o);var d=dotProduct(o,m);var e=1/(n*f-k*k);var r=(f*j-k*d)*e;var p=(n*d-k*j)*e;return(r>0)&&(p>0)&&(r+p<1)};var Node=function(c,b,a){this.id=c;this.text=b;this.type=a;this.x=0;this.y=0;this.vX=0;this.vY=0;this.subNodes=[]};Node.prototype.moveTo=function(a,c,b){b=typeof(b)!=="undefined"?b:true;this.x=a;this.y=c;$("div#"+this.id).css("left",(this.x-(this.width/2))+"px");$("div#"+this.id).css("top",(this.y-(this.height/2))+"px");if(b){g.drawLinks()}};Node.prototype.place=function(){var d=document.createElement("div");d.setAttribute("class","node");d.setAttribute("id",this.id);if(this.type=="text"){d.innerHTML='<a href="/node/'+this.id+'" id="'+this.id+'">'+this.text+"</a>"}else{if(this.type=="image"){d.innerHTML='<a href="/node/'+this.id+'" id="'+this.id+'"><img src="'+this.text+'" width="50px" /></a>'}}var b=document.getElementById("nodesDiv");b.appendChild(d);var c=$("div#"+this.id).width();var a=$("div#"+this.id).height();if(this.type=="image"){a=55}d.setAttribute("style","left:"+(this.x-(c/2))+"px; top:"+(this.y-(a/2))+"px;");this.width=c;this.height=a;var e=this;$("div#"+this.id).bind("mousedown",function(f){if(uiMode==="drag"){draggedNode=e;return false}else{newLink=new Link(0,e,false,"...");newLink.tx=f.pageX;newLink.ty=f.pageY;return false}});$("div#"+this.id).bind("click",function(f){if(dragging){dragging=false;return false}else{return true}});$("div#"+this.id).hover(function(f){if(newLink){newLink.targ=e}},function(f){})};var Link=function(d,c,a,b){this.id=d;this.orig=c;this.targ=a;this.type=b;this.ox=0;this.oy=0;this.tx=0;this.ty=0};Link.prototype.draw=function(d){var f=this.ox;var r=this.oy;if(this.orig){f=this.orig.x;r=this.orig.y}var e=this.tx;var q=this.ty;if(this.targ){e=this.targ.x;q=this.targ.y}var m=f+((e-f)/2);var j=r+((q-r)/2);var o=(q-r)/(e-f);var h=Math.atan(o);var k="#FFD326";var a="#000";if(~this.type.indexOf("direct")){k="#BEE512"}else{if(~this.type.indexOf("char")){k="#DFFD59"}else{if(~this.type.indexOf("play")){k="#FFFC26"}else{if(~this.type.indexOf("is")){k="#ED9107";a="#FFF"}}}}d.strokeStyle=k;d.fillStyle=k;d.lineWidth=0.7;d.beginPath();d.moveTo(f,r);d.lineTo(e,q);d.stroke();d.font="10pt Sans-Serif";var n=d.measureText(this.type);var c=n.width+6;var s=18;var b=[[0,0],[0,0],[0,0],[0,0],[0,0]];this.points=b;d.beginPath();if((f<e)||((f==e)&&(r<q))){b[0][0]=-(c/2);b[0][1]=-(s/2);b[1][0]=-(c/2);b[1][1]=(s/2);b[2][0]=(c/2);b[2][1]=(s/2);b[3][0]=(c/2)+6;b[3][1]=0;b[4][0]=(c/2);b[4][1]=-(s/2)}else{b[0][0]=-(c/2);b[0][1]=-(s/2);b[1][0]=-(c/2)-6;b[1][1]=0;b[2][0]=-(c/2);b[2][1]=(s/2);b[3][0]=(c/2);b[3][1]=(s/2);b[4][0]=(c/2);b[4][1]=-(s/2)}for(i=0;i<5;i++){rotateAndTranslate(b[i],h,m,j)}d.moveTo(b[0][0],b[0][1]);for(i=1;i<5;i++){d.lineTo(b[i][0],b[i][1])}d.closePath();d.fill();d.save();d.translate(m,j);d.rotate(h);d.fillStyle=a;d.textAlign="center";d.textBaseline="middle";d.fillText(this.type,0,0);d.restore()};Link.prototype.pointInLabel=function(a){return(pointInTriangle(this.points[0],this.points[1],this.points[2],a)||pointInTriangle(this.points[2],this.points[3],this.points[4],a)||pointInTriangle(this.points[0],this.points[2],this.points[4],a))};var Graph=function(a){this.context=a;this.nodes={};this.links=[];this.newNode=false;this.newNodeActive=false};Graph.prototype.drawLinks=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height);var a;for(a=0;a<this.links.length;a++){this.links[a].draw(this.context)}if(newLink){newLink.draw(this.context)}};Graph.prototype.placeNodes=function(){for(var a in this.nodes){this.nodes[a].place()}};Graph.prototype.layout=function(a,f,d,b,q,p,n,j){a.x=q+((Math.random()*50)-25);a.y=p+((Math.random()*50)-25);var h=a.subNodes.length;var c=n;var m=f*150;var r=0;if(h==1){c+=(j-n)/2;r=Math.PI}else{if(f==1){r=(j-n)/h}else{r=(j-n)/(h-1);r*=0.75}}var e;for(var e=0;e<h;e++){var o=d+(Math.sin(c)*m);var k=b+(Math.cos(c)*m);this.layout(a.subNodes[e],f+1,d,b,o,k,c-(r/2),c+(r/2));c+=r}};Graph.prototype.labelAtPoint=function(a,d){var c=[a,d];for(var b=this.links.length-1;b>=0;b--){if(this.links[b].pointInLabel(c)){return this.links[b]}}return -1};Graph.prototype.genNodeKeys=function(){this.nodeKeys=[];for(var a in this.nodes){this.nodeKeys.push(a)}};Graph.prototype.forceStep=function(){var h=0.85;var k=200;var s=0.06;for(var r in this.nodes){var b=this.nodes[r];b.fX=0;b.fY=0}for(var f=0;f<this.nodeKeys.length;f++){var q=this.nodes[this.nodeKeys[f]];for(var e=f+1;e<this.nodeKeys.length;e++){var o=this.nodes[this.nodeKeys[e]];var d=q.x-o.x;var c=q.y-o.y;var a=(d*d)+(c*c);var n=(d/a)*k;var m=(c/a)*k;q.fX+=n;q.fY+=m;o.fX-=n;o.fY-=m}}for(var f=0;f<this.links.length;f++){var p=this.links[f];var q=p.orig;var o=p.targ;var d=q.x-o.x;var c=q.y-o.y;var n=d*s;var m=c*s;q.fX-=n;q.fY-=m;o.fX+=n;o.fY+=m}for(var r in this.nodes){var b=this.nodes[r];b.vX=(b.vX+b.fX)*h;b.vY=(b.vY+b.fY)*h;b.x=b.x+b.vX;b.y=b.y+b.vY}};var dragMode=function(a){uiMode="drag";$("#dragModeButton").addClass("selModeButton");$("#addModeButton").removeClass("selModeButton")};var addMode=function(a){uiMode="add";$("#dragModeButton").removeClass("selModeButton");$("#addModeButton").addClass("selModeButton");$("#tip").html("Try clicking & dragging!");$("#tip").fadeIn("slow",function(){tipVisible=true})};var cycle=0;var graphAnim=function(){for(var b=0;b<20;b++){g.forceStep()}for(var a in g.nodes){var c=g.nodes[a];c.moveTo(c.x,c.y,false)}g.drawLinks();cycle+=1;if(cycle<5){setTimeout("graphAnim()",100)}};var g;var uiMode;var draggedNode;var dragging;var newLink;var tipVisible;var initInterface=function(){if(error!=""){$("#tip").html('<div class="error">'+error+"</div>");$("#tip").fadeIn("slow",function(){tipVisible=true})}newLink=false;draggedNode=false;dragging=false;curTargNode=false;tipVisible=false;$("#nodesDiv").bind("mousemove",(function(a){if(uiMode==="drag"){if(draggedNode){draggedNode.moveTo(a.pageX,a.pageY);dragging=true}}else{if(newLink){newLink.tx=a.pageX;newLink.ty=a.pageY;g.drawLinks();return false}}}));$("#nodesDiv").bind("mouseup",(function(a){if(uiMode==="drag"){draggedNode=false}else{if((newLink.orig)||(newLink.targ)){if(tipVisible){$(".tip").fadeOut("slow",function(){tipVisible=false})}$("#overlay").fadeIn(80,(function(b){$("#box").css({visibility:"visible"});if(newLink.orig){$("#dNode1").html(newLink.orig.text);$("#dNode1_id").val(newLink.orig.id);$("#dNode1").css({display:"block"});$("#dNode1In").css({display:"none"})}else{$("#dNode1").css({display:"none"});$("#dNode1In").css({display:"block"});$("#dNode1_id").val("none")}if(newLink.targ){$("#dNode2").html(newLink.targ.text);$("#dNode2_id").val(newLink.targ.id);$("#dNode2").css({display:"block"});$("#dNode2In").css({display:"none"})}else{$("#dNode2").css({display:"none"});$("#dNode2In").css({display:"block"});$("#dNode2_id").val("none")}newLink.targ=false}))}else{newLink=false;g.drawLinks()}}}));$("#boxclose").click(function(){$("#overlay").fadeOut(80,(function(a){$("#box").css({visibility:"hidden"});newLink=false;g.drawLinks()}))});dragMode();$("#dragModeButton").bind("click",dragMode);$("#addModeButton").bind("click",addMode);$("#nodesDiv").bind("mousedown",function(a){if(uiMode==="drag"){return false}else{newLink=new Link(0,false,false,"...");newLink.ox=a.pageX;newLink.oy=a.pageY;newLink.tx=a.pageX;newLink.ty=a.pageY;return false}});$("#nodesDiv").bind("click",(function(a){l=g.labelAtPoint(a.pageX,a.pageY);if(l!=-1){if(confirm('Do you want to delete connection:\n"'+l.orig.text+" "+l.type+" "+l.targ.text+'"?')){document.forms.delinkForm.elements.link_orig.value=l.orig.id;document.forms.delinkForm.elements.link_targ.value=l.targ.id;document.forms.delinkForm.elements.link_type.value=l.type;$("#delinkForm").submit()}}}))};var initGraph=function(){var e=document.getElementById("graphCanvas");var b=e.getContext("2d");g=new Graph(b);b.translate(0.5,0.5);var j;for(j=0;j<nodes.length;j++){var c=nodes[j];var a=c.id;var q=c.text;var m=c.type;var p=c.parent;var d=new Node(a,q,m);g.nodes[a]=d}for(j=0;j<nodes.length;j++){var c=nodes[j];var a=c.id;var p=c.parent;if(p==""){g.root=g.nodes[a];g.nodes[a].parent=false}else{g.nodes[a].parent=g.nodes[p];g.nodes[p].subNodes[g.nodes[p].subNodes.length]=g.nodes[a]}}g.genNodeKeys();for(j=0;j<links.length;j++){var f=links[j];var o=new Link(f.id,g.nodes[f.orig],g.nodes[f.targ],f.relation);g.links.push(o)}var h=window.innerWidth/2;var k=window.innerHeight/2;g.layout(g.root,1,h,k,h,k,0,Math.PI*2);b.canvas.width=window.innerWidth;b.canvas.height=window.innerHeight;g.drawLinks();g.placeNodes();graphAnim()};$(function(){initInterface();initGraph()});