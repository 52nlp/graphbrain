Object.prototype.size=function(){var a=this.length?--this.length:-1;for(var b in this){a++}return a};var rotateAndTranslate=function(c,h,d,b){var a=c[0];var j=c[1];var f=Math.cos(h)*a-Math.sin(h)*j;var e=Math.sin(h)*a+Math.cos(h)*j;a=f+d;j=e+b;c[0]=a;c[1]=j};var dotProduct=function(b,a){return(b[0]*a[0])+(b[1]*a[1])};var pointInTriangle=function(c,b,a,h){var p=[0,0];var n=[0,0];var l=[0,0];p[0]=a[0]-c[0];p[1]=a[1]-c[1];n[0]=b[0]-c[0];n[1]=b[1]-c[1];l[0]=h[0]-c[0];l[1]=h[1]-c[1];var m=dotProduct(p,p);var k=dotProduct(p,n);var j=dotProduct(p,l);var f=dotProduct(n,n);var d=dotProduct(n,l);var e=1/(m*f-k*k);var q=(f*j-k*d)*e;var o=(m*d-k*j)*e;return(q>0)&&(o>0)&&(q+o<1)};var interRect=function(b,l,a,k,f,r,m,n){var p,j,h,c;var q=a-b;var o=k-l;if((q==0)&&(o==0)){return 0}if(q!=0){var c;if(q>0){c=m}else{c=f}j=(c-b)/q}if(o!=0){var c;if(o>0){c=n}else{c=r}h=(c-l)/o}if(q==0){p=h}else{if(o==0){p=j}else{if(j<h){p=j}else{p=h}}}var e=b+q*p;var d=l+o*p;return[e,d]};var rectsOverlap=function(f,j,e,h,b,d,a,c){if(f<a&&e>b&&j<c&&h>d){return true}return false};var sepAxisSide=function(c,b,a){var d=((b.x-c.x)*(a.y-c.y))-((b.y-c.y)*(a.x-c.x));if(d<0){return -1}else{return 1}};var sepAxis=function(e,c,b,f){var d=sepAxisSide(e,c,b);var a=sepAxisSide(e,c,f.v1);if(d==a){return false}if(a!=sepAxisSide(e,c,f.v2)){return false}if(a!=sepAxisSide(e,c,f.v3)){return false}if(a!=sepAxisSide(e,c,f.v4)){return false}return true};var rotRectsOverlap=function(b,a){if(sepAxis(b.v1,b.v2,b.v3,a)){return false}if(sepAxis(b.v2,b.v3,b.v1,a)){return false}if(sepAxis(b.v3,b.v4,b.v1,a)){return false}if(sepAxis(b.v4,b.v1,b.v2,a)){return false}if(sepAxis(a.v1,a.v2,a.v3,b)){return false}if(sepAxis(a.v2,a.v3,a.v1,b)){return false}if(sepAxis(a.v3,a.v4,a.v1,b)){return false}if(sepAxis(a.v4,a.v1,a.v2,b)){return false}return true};var rectsDist2=function(b,n,a,l,q,f,p,e){if(rectsOverlap(b,n,a,l,q,f,p,e)){return 0}var j=b+((a-b)/2);var h=n+((l-n)/2);var o=q+((p-q)/2);var m=f+((e-f)/2);var s=interRect(j,h,o,m,b,n,a,l);var r=interRect(o,m,j,h,q,f,p,e);var d=s[0]-r[0];var c=s[1]-r[1];var k=(d*d)+(c*c);return k};var rectsDist=function(b,h,a,f,k,d,j,c){var e=rectsDist2(b,h,a,f,k,d,j,c);e=Math.sqrt(e);return e};var lineSegsOverlap=function(e,l,d,k,b,j,m,h){var f=(h-j)*(d-e)-(m-b)*(k-l);var c=(m-b)*(l-j)-(h-j)*(e-b);var a=(d-e)*(l-j)-(k-l)*(e-b);if(f==0){if((c==0)&&(a==0)){return true}else{return false}}c/=f;a/=f;if((c>=0)&&(c<=1)&&(a>=0)&&(a<=1)){return true}else{return false}};var lineRectOverlap=function(b,d,a,c,e){if(lineSegsOverlap(b,d,a,c,e.v1.x,e.v1.y,e.v2.x,e.v2.y)){return true}if(lineSegsOverlap(b,d,a,c,e.v2.x,e.v2.y,e.v3.x,e.v3.y)){return true}if(lineSegsOverlap(b,d,a,c,e.v3.x,e.v3.y,e.v4.x,e.v4.y)){return true}if(lineSegsOverlap(b,d,a,c,e.v4.x,e.v4.y,e.v1.x,e.v1.y)){return true}return false};tmpVec=new Array(3);var v3dotv3=function(d,c){return(d[0]*c[0])+(d[1]*c[1])+(d[2]*c[2])};var m4x4mulv3=function(a,c,d){var b;tmpVec[0]=a[3];tmpVec[1]=a[7];tmpVec[2]=a[11];b=v3dotv3(c,tmpVec)+a[15];tmpVec[0]=a[0];tmpVec[1]=a[4];tmpVec[2]=a[8];d[0]=(v3dotv3(c,tmpVec)+a[12])/b;tmpVec[0]=a[1];tmpVec[1]=a[5];tmpVec[2]=a[9];d[1]=(v3dotv3(c,tmpVec)+a[13])/b;tmpVec[0]=a[2];tmpVec[1]=a[6];tmpVec[2]=a[10];d[2]=(v3dotv3(c,tmpVec)+a[14])/b};var Quaternion=function(){this.x=0;this.y=0;this.z=0;this.w=1};Quaternion.prototype.fromEuler=function(b,f,c){var k=Math.sin(b);var d=Math.sin(f);var j=Math.sin(c);var h=Math.cos(b);var a=Math.cos(f);var e=Math.cos(c);this.x=j*h*a-e*k*d;this.y=e*k*a+j*h*d;this.z=e*h*d-j*k*a;this.w=e*h*a+j*k*d;this.normalise()};Quaternion.prototype.normalise=function(){var b=0.00001;var a=(this.x*this.x)+(this.y*this.y)+(this.z*this.z)+(this.w*this.w);if(Math.abs(a-1)>b){a=Math.sqrt(a);this.x/=a;this.y/=a;this.z/=a;this.w/=a}};Quaternion.prototype.mul=function(c){var a=(this.w*c.x)+(this.x*c.w)+(this.y*c.z)-(this.z*c.y);var e=(this.w*c.y)-(this.x*c.z)+(this.y*c.w)+(this.z*c.x);var d=(this.w*c.z)+(this.x*c.y)-(this.y*c.x)+(this.z*c.w);var b=(this.w*c.w)-(this.x*c.x)-(this.y*c.y)-(this.z*c.z);this.x=a;this.y=e;this.z=d;this.w=b};Quaternion.prototype.getMatrix=function(b){var a=this.x*this.x;var j=this.y*this.y;var f=this.z*this.z;var l=this.x*this.y;var k=this.x*this.z;var h=this.y*this.z;var e=this.w*this.x;var d=this.w*this.y;var c=this.w*this.z;b[0]=1-(2*(j+f));b[1]=2*(l-c);b[2]=2*(k+d);b[3]=0;b[4]=2*(l+c);b[5]=1-(2*(a+f));b[6]=2*(h-e);b[7]=0;b[8]=2*(k-d);b[9]=2*(h+e);b[10]=1-(2*(a+j));b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1};var makeVisualObj=function(a){a.rect=[];a.rect.v1=[];a.rect.v2=[];a.rect.v3=[];a.rect.v4=[];a.rect.v1.x=0;a.rect.v1.y=0;a.rect.v1.z=0;a.rect.v2.x=0;a.rect.v2.y=0;a.rect.v2.z=0;a.rect.v3.x=0;a.rect.v3.y=0;a.rect.v3.z=0;a.rect.v4.x=0;a.rect.v4.y=0;a.rect.v4.z=0;a.overlaps=function(b){return rotRectsOverlap(a.rect,b.rect)}};var nodeCount=0;var Node=function(d,c,b,a){this.id=d;this.divid="n"+nodeCount++;this.text=c;this.type=b;this.rpos=Array(3);this.subNodes=[];this.snode=a;this.sx=0;this.sy=0};Node.prototype.calcPos=function(){var b=$("#"+this.divid);var a=b.offset();this.rpos[0]=a.left+this.halfWidth;this.rpos[1]=a.top+this.halfHeight;this.rpos[2]=0;this.x0=this.rpos[0]-this.halfWidth;this.y0=this.rpos[1]-this.halfHeight;this.x1=this.rpos[0]+this.halfWidth;this.y1=this.rpos[1]+this.halfHeight;this.sx=this.rpos[0]-this.snode.x-this.snode.halfWidth;this.sy=this.rpos[1]-this.snode.y-this.snode.halfHeight};Node.prototype.estimatePos=function(){this.rpos[0]=this.snode.rpos[0]+this.sx;this.rpos[1]=this.snode.rpos[1]+this.sy;this.rpos[2]=this.snode.rpos[2];this.x0=this.rpos[0]-this.halfWidth;this.y0=this.rpos[1]-this.halfHeight;this.x1=this.rpos[0]+this.halfWidth;this.y1=this.rpos[1]+this.halfHeight};Node.prototype.place=function(){var d=document.createElement("div");d.setAttribute("class","node_"+this.snode.depth);d.setAttribute("id",this.divid);if(this.type=="text"){d.innerHTML='<a href="/node/'+this.id+'" id="'+this.divid+'">'+this.text+"</a>"}else{if(this.type=="image"){d.innerHTML='<a href="/node/'+this.id+'" id="'+this.divid+'"><img src="'+this.text+'" width="50px" /></a>'}}var b=document.getElementById(this.snode.id);b.appendChild(d);var e=$("#"+this.divid);var c=e.outerWidth();var a=e.outerHeight();if(this.type=="image"){c=50;a=80}this.width=c;this.height=a;this.halfWidth=c/2;this.halfHeight=a/2};var SNode=function(a){this.id=a;this.x=0;this.y=0;this.z=0;this.rpos=Array(3);this.auxVec=new Array(3);this.nodes={};this.subNodes=[];this.parent="unknown";this.links=[];this.weight=0;makeVisualObj(this)};SNode.prototype.updatePos=function(a,e){this.x=a;this.y=e;this.z=0;this.auxVec[0]=this.x-g.halfWidth;this.auxVec[1]=this.y-g.halfHeight;this.auxVec[2]=0;m4x4mulv3(g.affinMat,this.auxVec,this.rpos);this.rpos[0]+=g.halfWidth;this.rpos[1]+=g.halfHeight;this.x0=this.rpos[0]-this.halfWidth;this.y0=this.rpos[1]-this.halfHeight;this.x1=this.rpos[0]+this.halfWidth;this.y1=this.rpos[1]+this.halfHeight;this.rect.v1.x=this.rpos[0]-this.halfWidth;this.rect.v1.y=this.rpos[1]-this.halfHeight;this.rect.v2.x=this.rpos[0]-this.halfWidth;this.rect.v2.y=this.rpos[1]+this.halfHeight;this.rect.v3.x=this.rpos[0]+this.halfWidth;this.rect.v3.y=this.rpos[1]+this.halfHeight;this.rect.v4.x=this.rpos[0]+this.halfWidth;this.rect.v4.y=this.rpos[1]-this.halfHeight;for(var c in this.nodes){if(this.nodes.hasOwnProperty(c)){this.nodes[c].estimatePos()}}for(var b=0;b<this.links.length;b++){var d=this.links[b];d.updatePos()}};SNode.prototype.moveTo=function(a,c){this.updatePos(a,c);var b="translate3d("+(this.rpos[0]-this.halfWidth)+"px,"+(this.rpos[1]-this.halfHeight)+"px,"+this.rpos[2]+"px)";$("div#"+this.id).css("-webkit-transform",b)};SNode.prototype.place=function(){var c=document.createElement("div");var f=0;for(var d in this.nodes){if(this.nodes.hasOwnProperty(d)){f++}}if(f>1){c.setAttribute("class","snode_"+this.depth)}else{c.setAttribute("class","snode1_"+this.depth)}c.setAttribute("id",this.id);var b=document.getElementById("nodesDiv");b.appendChild(c);for(var d in this.nodes){if(this.nodes.hasOwnProperty(d)){this.nodes[d].place()}}var e=$("div#"+this.id).outerWidth();var a=$("div#"+this.id).outerHeight();this.width=e;this.height=a;this.halfWidth=e/2;this.halfHeight=a/2;this.moveTo(this.x,this.y);for(var d in this.nodes){if(this.nodes.hasOwnProperty(d)){this.nodes[d].calcPos()}}var h=this;$("div#"+this.id).bind("mousedown",function(j){if(uiMode==="drag"){draggedNode=h;return false}else{newLink=new Link(0,h,false,"...");newLink.tx=j.pageX;newLink.ty=j.pageY;return false}});$("div#"+this.id).bind("click",function(j){if(dragging){dragging=false;return false}else{return true}});$("div#"+this.id).hover(function(j){if(newLink){newLink.targ=h}},function(j){})};SNode.prototype.toString=function(){var a;for(a in this.nodes){if(this.nodes.hasOwnProperty(a)){return"{"+this.nodes[a].text+", ...}"}}};var Link=function(f,e,d,c,a,b){this.id=f;this.orig=e;this.sorig=d;this.targ=c;this.starg=a;this.label=b;this.ox=0;this.oy=0;this.tx=0;this.ty=0;this.len=0;makeVisualObj(this)};Link.prototype.updatePos=function(){var k=false;var f=false;var d=false;var h=false;if(this.orig){k=this.orig}else{if(this.sorig){k=this.sorig;this.origSuper=true}}if(this.targ){f=this.targ}else{if(this.starg){f=this.starg;this.targSuper=true}}var c=k.rpos[0];var l=k.rpos[1];var b=f.rpos[0];var j=f.rpos[1];p0=interRect(c,l,b,j,k.x0,k.y0,k.x1,k.y1);p1=interRect(b,j,c,l,f.x0,f.y0,f.x1,f.y1);this.x0=p0[0];this.y0=p0[1];this.z0=k.rpos[2];this.x1=p1[0];this.y1=p1[1];this.z1=f.rpos[2];var n=this.x1-this.x0;var m=this.y1-this.y0;this.dx=n;this.dy=m;this.len=(n*n)+(m*m);this.len=Math.sqrt(this.len);this.cx=this.x0+((this.x1-this.x0)/2);this.cy=this.y0+((this.y1-this.y0)/2);var e=(this.y1-this.y0)/(this.x1-this.x0);this.angle=Math.atan(e);var a=[[0,0],[0,0],[0,0],[0,0],[0,0]];if((this.x0<this.x1)||((this.x0==this.x1)&&(this.y0<this.y1))){a[0][0]=-this.halfWidth;a[0][1]=-this.halfHeight;a[1][0]=-this.halfWidth;a[1][1]=this.halfHeight;a[2][0]=this.halfWidth;a[2][1]=this.halfHeight;a[3][0]=this.halfWidth+6;a[3][1]=0;a[4][0]=this.halfWidth;a[4][1]=-this.halfHeight}else{a[0][0]=-this.halfWidth;a[0][1]=-this.halfHeight;a[1][0]=-this.halfWidth-6;a[1][1]=0;a[2][0]=-this.halfWidth;a[2][1]=this.halfHeight;a[3][0]=this.halfWidth;a[3][1]=this.halfHeight;a[4][0]=this.halfWidth;a[4][1]=-this.halfHeight}for(i=0;i<5;i++){rotateAndTranslate(a[i],this.angle,this.cx,this.cy)}this.points=a;if((this.x0<this.x1)||((this.x0==this.x1)&&(this.y0<this.y1))){this.rect.v1.x=a[0][0];this.rect.v1.y=a[0][1];this.rect.v2.x=a[1][0];this.rect.v2.y=a[1][1];this.rect.v3.x=a[2][0];this.rect.v3.y=a[2][1];this.rect.v4.x=a[4][0];this.rect.v4.y=a[4][1]}else{this.rect.v1.x=a[0][0];this.rect.v1.y=a[0][1];this.rect.v2.x=a[2][0];this.rect.v2.y=a[2][1];this.rect.v3.x=a[3][0];this.rect.v3.y=a[3][1];this.rect.v4.x=a[4][0];this.rect.v4.y=a[4][1]}};Link.prototype.draw=function(){this.updatePos();var c="#FFD326";var b="#000";if(~this.label.indexOf("direct")){c="#BEE512"}else{if(~this.label.indexOf("char")){c="#DFFD59"}else{if(~this.label.indexOf("play")){c="#FFFC26"}else{if(~this.label.indexOf("is")){c="#ED9107";b="#FFF"}}}}context.strokeStyle=c;context.fillStyle=c;context.lineWidth=0.7;context.beginPath();context.moveTo(this.x0,this.y0);context.lineTo(this.x1,this.y1);context.stroke();if(this.origSuper){context.fillStyle="#505050"}else{context.fillStyle=c}context.beginPath();var a=4;context.arc(this.x0,this.y0,a,0,2*Math.PI,false);context.fill();if(this.targSuper){context.fillStyle="#505050"}else{context.fillStyle=c}context.beginPath();context.arc(this.x1,this.y1,a,0,2*Math.PI,false);context.fill();context.fillStyle=c;context.beginPath();context.moveTo(this.points[0][0],this.points[0][1]);for(i=1;i<5;i++){context.lineTo(this.points[i][0],this.points[i][1])}context.closePath();context.fill();context.save();context.translate(this.cx,this.cy);context.rotate(this.angle);context.font="10pt Sans-Serif";context.fillStyle=b;context.textAlign="center";context.textBaseline="middle";context.fillText(this.label,0,0);context.restore()};Link.prototype.pointInLabel=function(a){return(pointInTriangle(this.points[0],this.points[1],this.points[2],a)||pointInTriangle(this.points[2],this.points[3],this.points[4],a)||pointInTriangle(this.points[0],this.points[2],this.points[4],a))};Link.prototype.intersectsLink=function(a){return lineSegsOverlap(this.x0,this.y0,this.x1,this.y1,a.x0,a.y0,a.x1,a.y1)};Link.prototype.intersectsSNode=function(a){return lineRectOverlap(this.x0,this.y0,this.x1,this.y1,a.rect)};Link.prototype.place=function(){var d=document.createElement("div");d.setAttribute("class","link");d.setAttribute("id","link"+this.id);var c=document.getElementById("nodesDiv");c.appendChild(d);$("#link"+this.id).append('<div class="linkLine" id="linkLine'+this.id+'"></div>');$("#link"+this.id).append('<div class="linkLabel" id="linkLabel'+this.id+'">'+this.label+"</div>");var b=$("#link"+this.id).outerHeight();this.halfHeight=b/2;var a=$("#linkLabel"+this.id).outerWidth();this.halfLabelWidth=a/2;$("#linkLine"+this.id).css("top",""+this.halfHeight+"px")};Link.prototype.visualUpdate=function(){var j=this.x1-this.x0;var e=this.y1-this.y0;var b=this.z1-this.z0;var f=this.x0+(j/2);var c=this.y0+(e/2);var a=this.z0+(b/2);var m=Math.sqrt((j*j)+(e*e)+(b*b));var n=Math.atan2(e,j);var o;if(j>=0){o=-Math.atan2(b*Math.cos(n),j)}else{o=Math.atan2(b*Math.cos(n),-j)}$("#link"+this.id).css("width",""+m+"px");$("#linkLine"+this.id).css("height","1px");$("#linkLabel"+this.id).css("left",""+((m/2)-this.halfLabelWidth)+"px");var k=f-(m/2);var h=c-this.halfHeight;var d=a;var l="translate3d("+k+"px,"+h+"px,"+d+"px) rotateZ("+n+"rad) rotateY("+o+"rad)";$("#link"+this.id).css("-webkit-transform",l)};var GraphPos=function(d,e,b){this.angDivs=12;this.radDivs=10;this.ang2=Math.PI*0.5;this.snode=d;this.halfWidth=e/2;this.halfHeight=b/2;this.done=false;this.angStep=0;this.radStep=1;this.x=this.halfWidth;this.y=this.halfHeight;if(this.snode.depth>1){var c=this.snode.parent.x-this.halfWidth;var a=this.snode.parent.y-this.halfHeight;this.baseAngle=Math.atan2(a,c);this.minRadius=Math.sqrt((c*c)+(a*a));this.maxRadius=Math.sqrt((this.halfWidth*this.halfWidth)+(this.halfHeight*this.halfHeight))}this.next()};GraphPos.prototype.next=function(){if(this.snode.depth==1){this.next1()}else{this.next2()}};GraphPos.prototype.next1=function(){if(this.angStep>=this.angDivs){this.radStep++;this.angStep=0}if(this.radStep>this.radDivs){this.done=true;return}var e=Math.PI*2*(this.angStep/this.angDivs);var d=this.halfWidth*(this.radStep/this.radDivs);var c=this.halfHeight*(this.radStep/this.radDivs);this.x=this.halfWidth+(d*Math.cos(e));this.y=this.halfHeight+(c*Math.sin(e));this.angStep++};GraphPos.prototype.next2=function(){if(this.angStep>=this.angDivs){this.radStep++;this.angStep=0}if(this.radStep>=this.radDivs){this.done=true;return}var b=(this.ang2*(this.angStep/this.angDivs))-(this.ang2/2);b+=this.baseAngle;var a=this.radStep/this.radDivs;a*=this.maxRadius-this.minRadius;a+=this.minRadius;this.x=this.halfWidth+(a*Math.cos(b));this.y=this.halfHeight+(a*Math.sin(b));this.angStep++};var Graph=function(){this.snodes={};this.nodes={};this.links=[];this.newNode=false;this.newNodeActive=false;this.quat=new Quaternion();this.deltaQuat=new Quaternion();this.affinMat=new Array(16);this.quat.getMatrix(this.affinMat)};Graph.prototype.rotateX=function(a){this.deltaQuat.fromEuler(a,0,0);this.quat.mul(this.deltaQuat);this.quat.normalise();this.quat.getMatrix(this.affinMat)};Graph.prototype.rotateY=function(a){this.deltaQuat.fromEuler(0,0,a);this.quat.mul(this.deltaQuat);this.quat.normalise();this.quat.getMatrix(this.affinMat)};Graph.prototype.placeNodes=function(){for(var a in this.snodes){if(this.snodes.hasOwnProperty(a)){this.snodes[a].place()}}};Graph.prototype.placeLinks=function(){var a;for(a=0;a<this.links.length;a++){this.links[a].place()}};Graph.prototype.updateViewLinks=function(){var a;for(a=0;a<this.links.length;a++){this.links[a].visualUpdate()}};Graph.prototype.updateView=function(){for(var a in this.snodes){if(this.snodes.hasOwnProperty(a)){var b=this.snodes[a];b.moveTo(b.x,b.y)}}this.updateViewLinks()};Graph.prototype.labelAtPoint=function(a,d){var c=[a,d];for(var b=this.links.length-1;b>=0;b--){if(this.links[b].pointInLabel(c)){return this.links[b]}}return -1};Graph.prototype.genSNodeKeys=function(){this.snodeKeys=[];for(var a in this.snodes){this.snodeKeys.push(a)}};Graph.prototype.layoutSNode=function(o,c,q,n){var e=100;o.fixed=true;var p=99999999;var v,t;var r=new GraphPos(o,q,n);while(!r.done){var a=0;var m=r.x;var h=r.y;o.updatePos(m,h);for(var w=0;w<c.length;w++){var b=c[w];if(o.overlaps(b)){a+=1000000}for(var u=0;u<o.links.length;u++){var f=o.links[u];if(f.overlaps(b)){a+=10000}}}for(var u=0;u<this.links.length;u++){var f=this.links[u];if(f.sorig.fixed&&f.starg.fixed){if(o.overlaps(f)){a+=10000}}}for(var u=0;u<this.links.length;u++){var f=this.links[u];if(f.sorig.fixed&&f.starg.fixed){for(var s=0;s<o.links.length;s++){var d=o.links[s];if(d.sorig.fixed&&d.starg.fixed){if(f.intersectsLink(d)){a+=10000}}}}}for(var u=0;u<o.links.length;u++){var f=o.links[u];if(f.sorig.fixed&&f.starg.fixed){a+=f.len}}if(a<p){p=a;v=m;t=h}r.next()}o.moveTo(v,t)};Graph.prototype.nextByWeight=function(e){var d=-1;var a=false;for(var c in this.snodes){if(this.snodes.hasOwnProperty(c)){var b=this.snodes[c];if((!b.fixed)&&(b.depth==e)){if(b.weight>d){d=b.weight;a=b}}}}return a};Graph.prototype.layout=function(e,b){this.halfWidth=e/2;this.halfHeight=b/2;for(var d in this.snodes){if(this.snodes.hasOwnProperty(d)){var c=this.snodes[d];c.fixed=false}}var h=[g.root];g.root.moveTo(e/2,b/2);g.root.fixed=true;var f=this.snodes.size();if(f>1){var c=this.nextByWeight(1);var a=e/2;a-=g.root.width/2;a-=c.width/2;a-=100;var j=b/2;c.moveTo(a,j);c.fixed=true;h.push(c)}if(f>2){var c=this.nextByWeight(1);if(c){var a=e/2;a+=g.root.width/2;a+=c.width/2;a+=100;var j=b/2;c.moveTo(a,j);c.fixed=true;h.push(c)}}if(f>3){var c=this.nextByWeight(1);if(c){var a=e/2;var j=b/2;j-=g.root.height/2;j-=c.height/2;j-=100;c.moveTo(a,j);c.fixed=true;h.push(c)}}if(f>4){var c=this.nextByWeight(1);if(c){var a=e/2;var j=b/2;j+=g.root.height/2;j+=c.height/2;j+=100;c.moveTo(a,j);c.fixed=true;h.push(c)}}for(var d in this.snodes){if(this.snodes.hasOwnProperty(d)){var c=this.snodes[d];if((c.depth==1)&&(!c.fixed)){this.layoutSNode(c,h,e,b);h.push(c)}}}for(var d in this.snodes){if(this.snodes.hasOwnProperty(d)){var c=this.snodes[d];if(c.depth==2){this.layoutSNode(c,h,e,b);h.push(c)}}}};var dragMode=function(a){uiMode="drag";$("#dragModeButton").addClass("selModeButton");$("#addModeButton").removeClass("selModeButton")};var addMode=function(a){uiMode="add";$("#dragModeButton").removeClass("selModeButton");$("#addModeButton").addClass("selModeButton");$("#tip").html("Try clicking & dragging!");$("#tip").fadeIn("slow",function(){tipVisible=true})};var g;var context;var uiMode;var draggedNode;var dragging;var newLink;var tipVisible;var lastX;var lastY;var initInterface=function(){if(error!=""){$("#tip").html('<div class="error">'+error+"</div>");$("#tip").fadeIn("slow",function(){tipVisible=true})}newLink=false;draggedNode=false;dragging=false;curTargNode=false;tipVisible=false;$("#nodesDiv").bind("mouseup",(function(a){dragging=false;if(uiMode==="drag"){draggedNode=false}else{if((newLink.orig)||(newLink.targ)){if(tipVisible){$(".tip").fadeOut("slow",function(){tipVisible=false})}$("#overlay").fadeIn(80,(function(b){$("#box").css({visibility:"visible"});if(newLink.orig){$("#dNode1").html(newLink.orig.text);$("#dNode1_id").val(newLink.orig.id);$("#dNode1").css({display:"block"});$("#dNode1In").css({display:"none"})}else{$("#dNode1").css({display:"none"});$("#dNode1In").css({display:"block"});$("#dNode1_id").val("none")}if(newLink.targ){$("#dNode2").html(newLink.targ.text);$("#dNode2_id").val(newLink.targ.id);$("#dNode2").css({display:"block"});$("#dNode2In").css({display:"none"})}else{$("#dNode2").css({display:"none"});$("#dNode2In").css({display:"block"});$("#dNode2_id").val("none")}newLink.targ=false}))}else{newLink=false;g.drawLinks()}}}));$("#nodesDiv").bind("mousedown",function(a){dragging=true;lastX=a.pageX;lastY=a.pageY;if(uiMode==="drag"){return false}else{newLink=new Link(0,false,false,"...");newLink.ox=a.pageX;newLink.oy=a.pageY;newLink.tx=a.pageX;newLink.ty=a.pageY;return false}});$("#nodesDiv").bind("mousemove",(function(c){if(dragging){var b=c.pageX-lastX;var a=c.pageY-lastY;lastX=c.pageX;lastY=c.pageY;g.rotateX(-b*0.0015);g.rotateY(a*0.0015);g.updateView()}if(uiMode==="drag"){if(draggedNode){draggedNode.moveTo(c.pageX,c.pageY);dragging=true}}else{if(newLink){newLink.tx=c.pageX;newLink.ty=c.pageY;g.drawLinks();return false}}}));$("#boxclose").click(function(){$("#overlay").fadeOut(80,(function(a){$("#box").css({visibility:"hidden"});newLink=false;g.drawLinks()}))});dragMode();$("#dragModeButton").bind("click",dragMode);$("#addModeButton").bind("click",addMode)};var initGraph=function(){g=new Graph();var x,w;for(x=0;x<snodes.length;x++){var y=snodes[x];var d=y.id;var v=y.nodes;var s=new SNode(d);for(w=0;w<v.length;w++){var m=v[w];var o=nodes[m];var p=o.text;var c=o.type;var k=o.parent;var t=new Node(m,p,c,s);s.nodes[m]=t;g.nodes[m]=t;if((s.parent=="unknown")||(k=="")){s.parent=k}}g.snodes[d]=s}for(x=0;x<snodes.length;x++){var d=snodes[x]["id"];var s=g.snodes[d];var k=s.parent;if(k==""){g.root=s;s.parent=false}else{s.parent=g.nodes[k].snode;g.nodes[k].snode.subNodes[g.nodes[k].snode.subNodes.length]=s}}for(var z in g.snodes){if(g.snodes.hasOwnProperty(z)){var s=g.snodes[z];s.weight=s.nodes.size();if(s.parent==""){s.depth=0}else{if(s.parent==g.root){s.depth=1;for(var x=0;x<s.subNodes.length;x++){var e=s.subNodes[x];s.weight+=e.nodes.size()}}else{s.depth=2}}}}g.genSNodeKeys();var A=0;for(x=0;x<links.length;x++){var u=links[x];var b="";var q="";var a="";var n="";if("orig" in u){b=g.nodes[u.orig];a=b.snode}else{b=false;a=g.snodes[u.sorig]}if("targ" in u){q=g.nodes[u.targ];n=q.snode}else{q=false;n=g.snodes[u.starg]}var f=new Link(A++,b,a,q,n,u.relation);g.links.push(f);a.links.push(f);n.links.push(f)}var h=window.innerWidth/2;var r=window.innerHeight/2;g.placeNodes();g.placeLinks();g.layout(window.innerWidth,window.innerHeight);g.updateView()};$(function(){initInterface();initGraph()});